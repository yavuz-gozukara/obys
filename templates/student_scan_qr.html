{% extends "base.html" %}

{% block title %}QR Kod Okut - Ders Yoklama Sistemi{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm p-4">
                <h2 class="text-center mb-4">QR Kod Okut</h2>
                <p class="text-center text-muted">Lütfen size verilen QR kod verisini aşağıdaki alana girin veya kameranızla okutun.</p>

                <!-- Elle veri girme kaldırıldı, sadece kamera ile okutma aktif -->

                <hr class="my-4">
                <p class="text-center">Veya kameranız ile okutmak için:</p>
                <div id="qr-reader" style="width:100%"></div>
                <div id="qr-reader-results"></div>
            </div>
        </div>
    </div>
</div>

<div>
  <h5>Bu oturuma katılan öğrenciler:</h5>
  <ul id="live-students"></ul>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script>
    function onScanSuccess(decodedText, decodedResult) {
        // QR kod okunduğunda otomatik olarak POST isteği gönder
        console.log(`Code matched = ${decodedText}`, decodedResult);
        html5QrcodeScanner.clear(); // Stop the scanner
        fetch("{{ url_for('student.qr_scan') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `qr_data=${encodeURIComponent(decodedText)}`
        }).then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                response.text().then(text => {
                    document.getElementById('qr-reader-results').innerHTML = text;
                });
            }
        });
    }

    function onScanError(errorMessage) {
        // Handle scan error.
        // console.warn(`Code scan error = ${errorMessage}`);
    }

    var html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader", {
            fps: 10,
            qrbox: 250,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
            videoConstraints: {
                facingMode: { exact: "environment" }
            }
        });
    html5QrcodeScanner.render(onScanSuccess, onScanError);

    // Oturum ID'sini backend'den alın (ör: bir değişken olarak gönderin)
    var session_id = "{{ session_id|default('') }}";
    var socket = io();

    // Odaya katıl
    if (session_id) {
      socket.emit('join', {room: 'session_' + session_id});
    }

    // Canlı öğrenci güncellemesi
    socket.on('attendance_update', function(data) {
      var ul = document.getElementById('live-students');
      var li = document.createElement('li');
      li.textContent = data.student_no + " - " + data.student_name;
      ul.appendChild(li);
    });
</script>
{% endblock %}
