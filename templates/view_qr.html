{% extends "base.html" %}

{% block content %}
<div class="container-fluid d-flex flex-column justify-content-center align-items-center" style="min-height: 90vh;">
    <div class="card shadow-lg border-0" style="background: rgba(255,255,255,0.97);">
        <div class="card-body text-center">
            <div>
                <img src="data:image/png;base64,{{ qr_image }}"
                     id="qr-image"
                     class="img-fluid"
                     style="max-width: 480px; min-width: 320px; width: 40vw; height: auto; border-radius: 16px; border: 4px solid #007bff; box-shadow: 0 0 32px #007bff44;"
                     alt="Yoklama QR Kodu">
            </div>
            <div class="mt-4">
                <button id="manual-refresh" class="btn btn-lg btn-primary mx-2">
                    <i class="fas fa-sync-alt"></i> Yenile
                </button>
                <a href="{{ url_for('attendance.view_course_sessions', course_id=session.DersID) }}" class="btn btn-lg btn-secondary mx-2">
                    <i class="fas fa-arrow-left"></i> Oturumlara Dön
                </a>
            </div>
            <div class="mt-4">
                <h5><strong>Son Yenileme:</strong> <span id="last-refresh">{{ now.strftime('%H:%M:%S') }}</span></h5>
                <h5><strong>Geçerlilik:</strong> <span id="remaining-time">30</span> saniye</h5>
            </div>
        </div>
    </div>
</div>

<div>
    <h5>Bu oturuma katılan öğrenciler:</h5>
    <ul id="live-students"></ul>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
    var session_id = "{{ session.OturumID }}"; // Oturum ID'sini backend'den gönderin
    var socket = io();

    // Odaya katıl
    socket.emit('join', {room: 'session_' + session_id});

    // Canlı öğrenci güncellemesi
    socket.on('attendance_update', function(data) {
        var ul = document.getElementById('live-students');
        var li = document.createElement('li');
        li.textContent = data.student_no + " - " + data.student_name;
        ul.appendChild(li);
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const qrImage = document.getElementById('qr-image');
    const lastRefresh = document.getElementById('last-refresh');
    const remainingTime = document.getElementById('remaining-time');
    const manualRefreshBtn = document.getElementById('manual-refresh');
    const sessionId = {{ session.OturumID | tojson }};
    let countdown;
    let autoRefreshTimer;

    function refreshQR() {
        fetch(`/refresh_qr/${sessionId}`)
            .then(function(response) {
                if (!response.ok) throw new Error('Ağ hatası');
                return response.json();
            })
            .then(function(data) {
                if (data.status === 'success') {
                    qrImage.src = `data:image/png;base64,${data.qr_image}`;
                    lastRefresh.textContent = new Date().toLocaleTimeString();
                    resetCountdown();
                }
            })
            .catch(function(error) {
                console.error('Yenileme hatası:', error);
                alert('Yenileme başarısız: ' + error.message);
            });
    }

    function resetCountdown() {
        clearInterval(countdown);
        let seconds = 5; // Burayı 10 yaptık
        remainingTime.textContent = seconds;

        countdown = setInterval(function() {
            seconds--;
            remainingTime.textContent = seconds;

            if (seconds <= 0) {
                clearInterval(countdown);
                refreshQR();
            }
        }, 1000);
    }

    manualRefreshBtn.addEventListener('click', function() {
        refreshQR();
    });

    autoRefreshTimer = setInterval(refreshQR, 5000);
    resetCountdown();

    window.addEventListener('beforeunload', function() {
        clearInterval(autoRefreshTimer);
        clearInterval(countdown);
    });
});
</script>

<style>
body {
    background: #f8f9fa;
}
#qr-image {
    transition: opacity 0.3s;
    margin: 0 auto;
    display: block;
}
#qr-image.refreshing {
    opacity: 0.7;
}
#manual-refresh:active {
    transform: scale(0.95);
}
</style>
{% endblock %}